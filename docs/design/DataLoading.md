# Species: Tree of Life — Data Loading Spec

**Status:** Draft v0.1  
**Date:** 2026-02-26  
**Audience:** iOS/macOS engineers, data pipeline engineers  

**See also:**
- [Architecture](SpeciesTreeOfLife.md) — module boundaries, concurrency model, API protocols
- [Favourites Spec](Favorites.md) — local-only favourites storage

---

## Table of Contents

1. [Overview](#1-overview)
2. [Database Files](#2-database-files)
3. [Schema](#3-schema)
4. [Bundled Database](#4-bundled-database)
5. [Reference Database Import](#5-reference-database-import)
6. [Validation & Rollback](#6-validation--rollback)
7. [Offline Data Pipeline](#7-offline-data-pipeline)
8. [Search Indexing](#8-search-indexing)
9. [DB Switching](#9-db-switching)
10. [Safe Delete](#10-safe-delete)

---

## 1. Overview

The app uses **SQLite with FTS5** (accessed via GRDB.swift) for all structured species data. There are up to three SQLite files in play at any time:

| File | Location | Mutable? | User-deletable? |
|---|---|---|---|
| `bundled.sqlite` | App bundle | **No** — read-only | **No** |
| `reference.sqlite` | `<Application Support>/Databases/` | **No** — imported atomically, opened read-only | Yes (advanced action) |
| `favorites.sqlite` | `<Application Support>/Favorites/` | Yes | Yes (via Clear All) |

This document covers `bundled.sqlite` and `reference.sqlite`. `favorites.sqlite` is specified in [Favorites.md](Favorites.md).

All database access is serialised through `DatabaseActor` (an actor in `STOLData`). No other package opens a SQLite file directly.

---

## 2. Database Files

### 2.1 Bundled Database (`bundled.sqlite`)

- **Format:** Prebuilt SQLite 3 file.
- **Bundle location:** App bundle root, accessed via `Bundle.main.url(forResource: "bundled", withExtension: "sqlite")`.
- **Open flags:** `SQLITE_OPEN_READONLY | SQLITE_OPEN_NOMUTEX`. No write path exists in any code path.
- **Build time:** Generated by the offline pipeline (see §7) and committed to the repo, or produced by CI and embedded into the app at build time.
- **Target size:** ≤ 20 MB compressed (zstd page compression or VACUUM + zstd at export time). Larger datasets are offered as optional reference DBs.

### 2.2 Reference Database (`reference.sqlite`)

- **Format:** A gzip-compressed SQLite file with a `.stol` extension and MIME type `application/x-stol-db`.
- **File structure:**

  ```
  ┌─────────────────────────────────┐
  │  8-byte magic: "STOL\x00DB\x01" │
  │  4-byte schema_version (LE)     │
  │  32-byte SHA-256 of gzip payload│
  │  64-byte Ed25519 signature      │
  │  gzip-compressed SQLite body    │
  └─────────────────────────────────┘
  ```

- **Stored location:** `<Application Support>/Databases/reference.sqlite` (after decompression and validation).
- **Open flags:** `SQLITE_OPEN_READONLY | SQLITE_OPEN_NOMUTEX`. Never written to at runtime.
- **Activation:** Controlled by `UserDefaults` key `useReferenceDB` (Bool). Default: `false`.

---

## 3. Schema

Both `bundled.sqlite` and `reference.sqlite` share an identical schema. The schema version is recorded in `schema_version`; the app refuses to open a DB whose version is higher than what it understands.

### 3.1 `schema_version`

```sql
CREATE TABLE schema_version (
    version     INTEGER NOT NULL,
    applied_at  TEXT    NOT NULL DEFAULT (strftime('%Y-%m-%dT%H:%M:%SZ','now'))
);
-- Always contains exactly one row.
INSERT INTO schema_version (version) VALUES (1);
```

### 3.2 `taxa`

The core taxonomy tree. Each row is one taxon; the tree is encoded as an adjacency list via `parent_id`.

```sql
CREATE TABLE taxa (
    id              INTEGER PRIMARY KEY,
    parent_id       INTEGER REFERENCES taxa(id),
    rank            TEXT    NOT NULL
        CHECK (rank IN ('domain','kingdom','phylum','class','order','family','genus','species')),
    scientific_name TEXT    NOT NULL,
    author          TEXT,
    year            INTEGER,
    status          TEXT    NOT NULL DEFAULT 'accepted'
        CHECK (status IN ('accepted','synonym','doubtful')),
    conservation    TEXT    -- IUCN code: 'LC','NT','VU','EN','CR','EW','EX','NE','DD'
);

CREATE INDEX idx_taxa_parent ON taxa(parent_id);
CREATE INDEX idx_taxa_rank   ON taxa(rank);
CREATE INDEX idx_taxa_status ON taxa(status);
CREATE INDEX idx_taxa_name   ON taxa(scientific_name);
```

### 3.3 `names`

Common names, synonyms, and vernacular names in multiple languages. One taxon can have many names.

```sql
CREATE TABLE names (
    id          INTEGER PRIMARY KEY,
    taxon_id    INTEGER NOT NULL REFERENCES taxa(id) ON DELETE CASCADE,
    name        TEXT    NOT NULL,
    lang        TEXT    NOT NULL,   -- BCP-47 language tag, e.g. 'en', 'es', 'zh-Hans'
    name_type   TEXT    NOT NULL
        CHECK (name_type IN ('common','synonym','vernacular','trade')),
    is_preferred INTEGER NOT NULL DEFAULT 0  -- 1 = preferred common name for this language
);

CREATE INDEX idx_names_taxon ON names(taxon_id);
CREATE INDEX idx_names_lang  ON names(lang);
CREATE INDEX idx_names_type  ON names(name_type);
```

### 3.4 `refs`

Taxonomic, ecological, and conservation references.

```sql
CREATE TABLE refs (
    id          INTEGER PRIMARY KEY,
    taxon_id    INTEGER NOT NULL REFERENCES taxa(id) ON DELETE CASCADE,
    citation    TEXT    NOT NULL,
    url         TEXT,               -- DOI or static URL (displayed as text in v1; not fetched)
    ref_type    TEXT    NOT NULL
        CHECK (ref_type IN ('taxonomy','ecology','morphology','conservation','other'))
);

CREATE INDEX idx_refs_taxon ON refs(taxon_id);
```

### 3.5 `traits` (Optional)

Key-value trait table. Populated when source data includes trait information.

```sql
CREATE TABLE traits (
    id          INTEGER PRIMARY KEY,
    taxon_id    INTEGER NOT NULL REFERENCES taxa(id) ON DELETE CASCADE,
    trait_key   TEXT    NOT NULL,   -- e.g. 'habitat', 'diet', 'body_length_mm'
    trait_value TEXT    NOT NULL,
    unit        TEXT,               -- SI unit if numeric; NULL if categorical
    source_ref  INTEGER REFERENCES refs(id)
);

CREATE INDEX idx_traits_taxon ON traits(taxon_id);
CREATE INDEX idx_traits_key   ON traits(trait_key);
```

### 3.6 `euler_tour` & `first_occurrence` (LCA Helpers)

Precomputed by the offline pipeline to support O(1) Lowest Common Ancestor queries on-device.

```sql
-- Euler-tour DFS sequence: each node appears (2 * depth + 1) times.
-- Length of tour = 2N - 1 for a tree of N nodes.
CREATE TABLE euler_tour (
    seq         INTEGER PRIMARY KEY,
    taxon_id    INTEGER NOT NULL REFERENCES taxa(id),
    depth       INTEGER NOT NULL
);

-- First position in the Euler tour where each taxon appears.
CREATE TABLE first_occurrence (
    taxon_id    INTEGER PRIMARY KEY REFERENCES taxa(id),
    seq         INTEGER NOT NULL
);
```

These tables are populated at DB build time and are read-only on device. If absent (e.g., older bundled DB), the compare engine falls back to on-demand path-to-root LCA.

### 3.7 `top_n_relatives`

Precomputed top-N closest relatives per species. Populated by the offline pipeline.

```sql
-- Only populated for leaf taxa (rank = 'species').
-- Default N = 10 at pipeline build time.
CREATE TABLE top_n_relatives (
    taxon_id    INTEGER NOT NULL REFERENCES taxa(id),
    relative_id INTEGER NOT NULL REFERENCES taxa(id),
    rank_order  INTEGER NOT NULL,   -- 1 = closest
    lca_id      INTEGER NOT NULL REFERENCES taxa(id),
    lca_depth   INTEGER NOT NULL,
    distance    INTEGER NOT NULL,   -- (depth_a - lca_depth) + (depth_b - lca_depth)
    PRIMARY KEY (taxon_id, rank_order)
);

CREATE INDEX idx_top_n_taxon ON top_n_relatives(taxon_id);
```

### 3.8 `fts_taxa` (Full-Text Search)

FTS5 virtual table for search queries.

```sql
-- Contentless FTS (lower storage; rebuilt by pipeline, not on-device).
CREATE VIRTUAL TABLE fts_taxa USING fts5(
    taxon_id UNINDEXED,
    scientific_name,
    common_names,   -- space-separated concatenation of all names where type IN ('common','vernacular')
    synonyms,       -- space-separated concatenation of names where type = 'synonym'
    content='',
    tokenize='unicode61 remove_diacritics 2'
);
```

---

## 4. Bundled Database

### 4.1 Source Datasets

Candidate source datasets for the bundled DB:

| Dataset | License | Records |
|---|---|---|
| GBIF Backbone Taxonomy | CC0 1.0 | ~9 M taxa (use subset: accepted species + parents) |
| Open Tree of Life (OTL) | CC0 1.0 | ~2.3 M tips |
| ITIS | Public Domain | ~900 k taxa |
| Catalogue of Life | CC BY 4.0 | ~4 M species |

**Recommended for v1 bundled DB:** GBIF backbone subset (accepted taxa from Kingdom to Species, ~500 k rows) + OTL for phylogenetic context. This achieves < 20 MB target.

### 4.2 Build-Time Generation

The bundled DB is generated by the offline pipeline (`Pipeline/build_db.py`) and embedded at build time. It is **never regenerated at runtime**. Engineers follow this flow when updating the bundled dataset:

1. Update source files in `Pipeline/data/`.
2. Run `make build-db` (runs `build_db.py`, `compute_top_n.py`, then optionally `sign_db.py` for reference DB variant).
3. Confirm output size ≤ 20 MB.
4. Commit `App/Shared/Resources/bundled.sqlite` to the repo (or upload as a build artifact for large files).
5. Bump `schema_version` if schema changed; update the app's expected version constant.

---

## 5. Reference Database Import

### 5.1 User-Initiated Flow

```
User taps "Import Reference Database" in Settings
    → Document picker opens (filter: UTType com.species.stol-db)
    → User selects a .stol file
    → ImportService.importReferenceDB(from: url) is called
        [1] Copy to <tmp>/stol_import_<UUID>.stol.gz
        [2] Read and validate 8-byte magic header
        [3] Verify SHA-256 of gzip body against header bytes
        [4] Verify Ed25519 signature against header bytes using hardcoded public key
        [5] Decompress gzip to <tmp>/stol_import_<UUID>.sqlite
        [6] Open candidate DB; check schema_version ≤ app's expected version
        [7] Run PRAGMA integrity_check; must return "ok"
        [8] Atomic rename: <tmp>/stol_import_<UUID>.sqlite → <AppSupport>/Databases/reference.sqlite
        [9] Activate reference DB (see §9)
        [10] Delete all <tmp>/stol_import_* files
    → Progress reported to UI via AsyncStream<ImportProgress>
```

### 5.2 File Size Limits

| Limit | Value | Reason |
|---|---|---|
| Minimum file size | 1 byte | Guard against empty files |
| Maximum file size | 2 GB | SQLite architectural limit; device storage practical limit |
| Maximum decompressed size | 4 GB | Guard against decompression bombs |

---

## 6. Validation & Rollback

### 6.1 Validation Checklist

Every import attempt runs these checks in order. Any failure aborts the import.

| # | Check | Method | Error type |
|---|---|---|---|
| 1 | File exists and is readable | `FileManager.fileExists` | `ImportError.fileUnreadable` |
| 2 | File size within limits | Byte count check | `ImportError.fileTooLarge` |
| 3 | Magic header correct | Compare first 8 bytes | `ImportError.notAStolFile` |
| 4 | SHA-256 checksum matches | Compute over gzip body; compare to header | `ImportError.checksumMismatch` |
| 5 | Ed25519 signature valid | CryptoKit `Curve25519.Signing.PublicKey.isValidSignature` | `ImportError.signatureInvalid` |
| 6 | Schema version compatible | `SELECT version FROM schema_version` ≤ app constant | `ImportError.incompatibleSchema(found:expected:)` |
| 7 | SQLite integrity | `PRAGMA integrity_check` = `"ok"` | `ImportError.databaseCorrupt(detail:)` |

### 6.2 Rollback Guarantee

If any validation step (1–7) fails:

1. All files matching `<tmp>/stol_import_*` are deleted immediately.
2. `<AppSupport>/Databases/reference.sqlite` is **never touched** (left absent if this was a fresh import, or left as the previously valid file if a re-import was attempted).
3. `UserDefaults["useReferenceDB"]` is **not changed**.
4. A typed `ImportError` is surfaced to the UI; the user sees a localized error message.
5. No crash, no silent failure.

### 6.3 Error Recovery

After any import failure, the app continues to function normally using the bundled DB (or the previously activated reference DB if one exists). The user may retry the import at any time.

---

## 7. Offline Data Pipeline

The offline pipeline runs on a developer machine or in CI — **never on device**.

### 7.1 Tools

| Script | Language | Purpose |
|---|---|---|
| `Pipeline/build_db.py` | Python 3 | Download/parse source datasets; build `bundled.sqlite` with all tables |
| `Pipeline/compute_top_n.py` | Python 3 | Populate `euler_tour`, `first_occurrence`, `top_n_relatives` tables |
| `Pipeline/sign_db.py` | Python 3 | Compress + sign a candidate DB → `.stol` reference DB file |

### 7.2 Pipeline Steps

```
[Input]
  Source datasets (GBIF TSV / OTL JSON / ITIS SQLite / CoL CSV)
      │
      ▼
[1] build_db.py
      ├─ Parse and normalise taxa, names, refs, traits
      ├─ Assign stable integer IDs
      ├─ Insert all rows into SQLite
      ├─ Build FTS5 index (INSERT INTO fts_taxa …)
      ├─ Run VACUUM to compact
      └─ Output: candidate.sqlite
      │
      ▼
[2] compute_top_n.py
      ├─ Load full taxa tree into memory
      ├─ Perform Euler-tour DFS; populate euler_tour + first_occurrence
      ├─ For each species-rank taxon:
      │     Walk outward by rank (genus → family → order → …)
      │     Collect top-N candidates by LCA distance
      │     Insert into top_n_relatives
      └─ Output: candidate.sqlite (with LCA tables populated)
      │
      ▼
[3a] For bundled DB:
      ├─ VACUUM candidate.sqlite
      ├─ Compress (zstd or gzip)
      ├─ Verify size ≤ 20 MB
      └─ Copy to App/Shared/Resources/bundled.sqlite

[3b] For reference DB:
      └─ sign_db.py:
            ├─ Compress to gzip
            ├─ Compute SHA-256 of gzip body
            ├─ Sign SHA-256 + schema_version with Ed25519 private key
            ├─ Write header + gzip body to output.stol
            └─ Output: SpeciesDB-vX.Y.stol
```

### 7.3 Signing Keys

The Ed25519 private key used to sign reference DBs is:

- Held only by authorised pipeline operators; stored in a secrets manager (never committed to the repo).
- The corresponding **public key is hardcoded** in `STOLImport` — it cannot be changed without an app update. This prevents a compromised distribution channel from substituting a malicious DB.

---

## 8. Search Indexing

### 8.1 FTS5 Query Strategy

The FTS5 virtual table `fts_taxa` is queried by `SearchService`. All queries are local; no network call is made.

| Query type | FTS5 syntax | Example |
|---|---|---|
| Exact match | `"term"` | `"panthera leo"` |
| Prefix / autocomplete | `term*` | `panth*` |
| Multi-word | `word1 word2` (implicit AND) | `leo lion` |
| Phrase | `"word1 word2"` | `"tree frog"` |
| Rank filter | FTS query + `WHERE taxa.rank = ?` JOIN | rank = 'genus' |

### 8.2 Fuzzy Fallback

When FTS5 returns fewer than 3 results for a query, `SearchService` falls back to a client-side Levenshtein distance pass over the top-20 FTS candidates from a broader prefix query. Maximum edit distance: 2 for queries ≥ 5 characters; 1 for shorter queries.

### 8.3 Index Maintenance

The FTS5 index is **built offline** by the pipeline (contentless `content=''`). It is never rebuilt on device. The index is consistent with the taxonomy data at DB build time; there is no incremental update mechanism.

---

## 9. DB Switching

### 9.1 Activation Flow

```
User enables "Use Reference Database" in Settings
    → DatabaseProvider.activateReferenceDB()
        ├─ Open reference.sqlite read-only
        ├─ Verify schema_version
        ├─ Set UserDefaults["useReferenceDB"] = true
        └─ DatabaseActor switches active connection to reference DB
    → Posts Notification .databaseDidSwitch
    → All open ViewModels observe the notification and reload their data
```

### 9.2 Deactivation Flow

```
User disables "Use Reference Database" in Settings
    → DatabaseProvider.deactivateReferenceDB(delete: false)
        ├─ Set UserDefaults["useReferenceDB"] = false
        ├─ Close reference DB connection
        └─ DatabaseActor switches active connection back to bundled DB
    → Posts Notification .databaseDidSwitch
    → ViewModels reload
```

### 9.3 Error Fallback

If the reference DB file is missing, corrupt, or has an incompatible schema at activation time:

- Log the error via OSLog (category `db`, level `.error`).
- Set `UserDefaults["useReferenceDB"] = false` automatically.
- Continue with bundled DB — no crash, no user alert unless the user explicitly triggered the switch.

---

## 10. Safe Delete

The reference DB can be deleted to free storage. The bundled DB is **never deletable**.

### 10.1 Delete Flow

```
User taps "Delete Reference Database" in Settings → Storage
    → Confirmation sheet: "The app will revert to the built-in database."
    → User confirms
    → DatabaseProvider.deactivateReferenceDB(delete: true)
        ├─ Set UserDefaults["useReferenceDB"] = false
        ├─ Close reference DB connection
        ├─ Delete <AppSupport>/Databases/reference.sqlite
        └─ DatabaseActor reverts to bundled DB
    → Posts Notification .databaseDidSwitch
    → Settings shows: Reference DB — "Not installed"
```

### 10.2 Safety Invariants

These invariants must be enforced in code and verified by unit tests:

1. `deactivateReferenceDB(delete: true)` **never touches** `bundled.sqlite` under any code path.
2. After deletion, `DatabaseActor` must use `bundledDB` exclusively.
3. `isReferenceDBActive` must return `false` immediately after the call returns.
4. The user can re-import a reference DB at any time after deletion.
